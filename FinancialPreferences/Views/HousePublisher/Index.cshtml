@{
    ViewData["Title"] = "房屋刊登系統";
}

<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary">
                <i class="fas fa-home"></i> 房屋刊登系統
            </h2>
            <hr>
        </div>
    </div>

    <!-- 搜尋和操作區域 -->
    <div class="row mb-3">
        <div class="col-md-8">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="搜尋房屋名稱或地址...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i> 搜尋
                </button>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#houseModal" onclick="openCreateModal()">
                <i class="fas fa-plus"></i> 新增房屋
            </button>
        </div>
    </div>

    <!-- 房屋列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- 載入指示器 -->
                    <div id="loadingIndicator" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-2">正在載入房屋資料...</p>
                    </div>

                    <!-- 錯誤訊息 -->
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="errorText">載入資料時發生錯誤，請稍後再試。</span>
                    </div>

                    <!-- 無資料訊息 -->
                    <div id="noDataMessage" class="text-center py-4" style="display: none;">
                        <i class="fas fa-home fa-3x text-muted"></i>
                        <h5 class="mt-3 text-muted">尚無房屋資料</h5>
                        <p class="text-muted">點擊上方「新增房屋」按鈕開始建立房屋資料</p>
                    </div>

                    <div class="table-responsive" id="houseTableContainer" style="display: none;">
                        <table class="table table-striped table-hover" id="houseTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>房屋名稱</th>
                                    <th>地址</th>
                                    <th>總價格</th>
                                    <th>坪數</th>
                                    <th>建立時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="houseTableBody">
                                <!-- 動態載入的房屋資料 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 分頁 -->
                    <nav aria-label="房屋列表分頁" id="paginationContainer" style="display: none;">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">上一頁</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">下一頁</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/編輯房屋 Modal -->
<div class="modal fade" id="houseModal" tabindex="-1" aria-labelledby="houseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="houseModalLabel">新增房屋</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="houseForm">
                    <input type="hidden" id="houseId" name="id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="houseName" class="form-label">房屋名稱 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="houseName" name="houseName" required maxlength="200">
                                <div class="invalid-feedback">請輸入房屋名稱</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="floorArea" class="form-label">坪數 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="floorArea" name="floorArea" required step="0.01" min="0">
                                    <span class="input-group-text">坪</span>
                                </div>
                                <div class="invalid-feedback">請輸入正確的坪數</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">地址 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="address" name="address" required maxlength="500">
                        <div class="invalid-feedback">請輸入地址</div>
                    </div>

                    <div class="mb-3">
                        <label for="totalPrice" class="form-label">總價格 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" class="form-control" id="totalPrice" name="totalPrice" required min="0" step="1">
                        </div>
                        <div class="invalid-feedback">請輸入正確的價格</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="4" maxlength="2000" placeholder="請輸入房屋詳細描述..."></textarea>
                        <div class="form-text">最多 2000 字元</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveHouse()">
                    <i class="fas fa-save"></i> 儲存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 房屋詳細資料檢視 Modal -->
<div class="modal fade" id="houseDetailModal" tabindex="-1" aria-labelledby="houseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="houseDetailModalLabel">房屋詳細資料</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">房屋名稱</label>
                            <p class="form-control-plaintext" id="detailHouseName">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">總價格</label>
                            <p class="form-control-plaintext text-success fw-bold fs-5" id="detailTotalPrice">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">坪數</label>
                            <p class="form-control-plaintext" id="detailFloorArea">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">地址</label>
                            <p class="form-control-plaintext" id="detailAddress">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">建立時間</label>
                            <p class="form-control-plaintext" id="detailCreatedDate">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">更新時間</label>
                            <p class="form-control-plaintext" id="detailUpdatedDate">-</p>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">描述</label>
                    <div class="border rounded p-3 bg-light">
                        <p class="mb-0" id="detailDescription">無描述</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" onclick="editHouseFromDetail()">
                    <i class="fas fa-edit"></i> 編輯
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 確認刪除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您確定要刪除房屋 「<span id="deleteHouseName" class="fw-bold"></span>」 嗎？</p>
                <p class="text-muted">此操作無法復原。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> 確定刪除
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 全域變數
        let currentEditingId = null;
        let currentDeletingId = null;
        let housesData = []; // 儲存房屋資料

        // API 基礎 URL
        const API_BASE_URL = '/api/houses';

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('房屋刊登系統已載入');
            loadHouseList(); // 載入房屋列表
        });

        // 載入房屋列表
        async function loadHouseList() {
            try {
                showLoadingIndicator();
                hideErrorMessage();

                console.log('正在從 API 載入房屋資料...');

                const response = await fetch(API_BASE_URL, {
                    method: 'GET',
                    headers:
                     {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const houses = await response.json();
                housesData = houses; // 儲存到全域變數

                console.log('成功載入房屋資料：', houses);

                hideLoadingIndicator();
                renderHouseTable(houses);

            } catch (error) {
                console.error('載入房屋資料時發生錯誤：', error);
                hideLoadingIndicator();
                showErrorMessage('載入房屋資料時發生錯誤：' + error.message);
            }
        }

        // 渲染房屋表格
        function renderHouseTable(houses) {
            const tableBody = document.getElementById('houseTableBody');
            const tableContainer = document.getElementById('houseTableContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            const paginationContainer = document.getElementById('paginationContainer');

            if (!houses || houses.length === 0) {
                // 沒有資料時顯示提示訊息
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
                noDataMessage.style.display = 'block';
                return;
            }

            // 有資料時顯示表格
            noDataMessage.style.display = 'none';
            tableContainer.style.display = 'block';
            paginationContainer.style.display = 'block';

            // 清空現有內容
            tableBody.innerHTML = '';

            // 生成表格行
            houses.forEach(house => {
                const row = createHouseTableRow(house);
                tableBody.appendChild(row);
            });
        }

        // 建立房屋表格行
        function createHouseTableRow(house) {
            const row = document.createElement('tr');

            // 格式化價格
            const formattedPrice = new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(house.totalPrice).replace('NT$', 'NT$');

            // 格式化日期
            const formattedDate = new Date(house.createdDate).toLocaleDateString('zh-TW');

            row.innerHTML = `
                <td>${escapeHtml(house.houseName)}</td>
                <td>${escapeHtml(house.address)}</td>
                <td class="text-success fw-bold">${formattedPrice}</td>
                <td>${house.floorArea} 坪</td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="viewHouse('${house.id}')" data-bs-toggle="modal" data-bs-target="#houseDetailModal">
                        <i class="fas fa-eye"></i> 檢視
                    </button>
                    <button class="btn btn-sm btn-warning me-1" onclick="editHouse('${house.id}')" data-bs-toggle="modal" data-bs-target="#houseModal">
                        <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteHouse('${house.id}')">
                        <i class="fas fa-trash"></i> 刪除
                    </button>
                </td>
            `;

            return row;
        }

        // HTML 轉義函數
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 顯示載入指示器
        function showLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('houseTableContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        // 隱藏載入指示器
        function hideLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // 顯示錯誤訊息
        function showErrorMessage(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('houseTableContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        // 隱藏錯誤訊息
        function hideErrorMessage() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // 根據 ID 尋找房屋資料
        function findHouseById(houseId) {
            return housesData.find(house => house.id === houseId);
        }

        // 開啟新增 Modal
        function openCreateModal() {
            document.getElementById('houseModalLabel').textContent = '新增房屋';
            document.getElementById('houseForm').reset();
            document.getElementById('houseId').value = '';
            currentEditingId = null;

            // 清除驗證樣式
            clearValidationStyles();
        }

        // 開啟編輯 Modal
        function editHouse(houseId) {
            currentEditingId = houseId;
            document.getElementById('houseModalLabel').textContent = '編輯房屋';

            const house = findHouseById(houseId);
            if (house) {
                loadHouseDataForEdit(house);
            } else {
                console.error('找不到指定的房屋：', houseId);
                alert('找不到指定的房屋資料');
            }
        }

        // 從詳細檢視頁面開啟編輯
        function editHouseFromDetail() {
            document.getElementById('houseDetailModal').addEventListener('hidden.bs.modal', function() {
                editHouse(currentEditingId);
                const editModal = new bootstrap.Modal(document.getElementById('houseModal'));
                editModal.show();
            }, { once: true });

            bootstrap.Modal.getInstance(document.getElementById('houseDetailModal')).hide();
        }

        // 載入編輯資料
        function loadHouseDataForEdit(house) {
            document.getElementById('houseId').value = house.id;
            document.getElementById('houseName').value = house.houseName || '';
            document.getElementById('address').value = house.address || '';
            document.getElementById('totalPrice').value = house.totalPrice || '';
            document.getElementById('floorArea').value = house.floorArea || '';
            document.getElementById('description').value = house.description || '';
        }

        // 檢視房屋詳細資料
        function viewHouse(houseId) {
            currentEditingId = houseId;

            const house = findHouseById(houseId);
            if (house) {
                // 格式化價格
                const formattedPrice = new Intl.NumberFormat('zh-TW', {
                    style: 'currency',
                    currency: 'TWD',
                    minimumFractionDigits: 0
                }).format(house.totalPrice);

                // 格式化日期時間
                const formattedCreatedDate = new Date(house.createdDate).toLocaleString('zh-TW');
                const formattedUpdatedDate = new Date(house.updatedDate).toLocaleString('zh-TW');

                document.getElementById('detailHouseName').textContent = house.houseName || '-';
                document.getElementById('detailAddress').textContent = house.address || '-';
                document.getElementById('detailTotalPrice').textContent = formattedPrice;
                document.getElementById('detailFloorArea').textContent = `${house.floorArea} 坪`;
                document.getElementById('detailDescription').textContent = house.description || '無描述';
                document.getElementById('detailCreatedDate').textContent = formattedCreatedDate;
                document.getElementById('detailUpdatedDate').textContent = formattedUpdatedDate;
            } else {
                console.error('找不到指定的房屋：', houseId);
                alert('找不到指定的房屋資料');
            }
        }

        // 儲存房屋
        function saveHouse() {
            const form = document.getElementById('houseForm');

            if (validateForm()) {
                // 收集表單資料
                const formData = {
                    id: document.getElementById('houseId').value || null,
                    houseName: document.getElementById('houseName').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    totalPrice: parseFloat(document.getElementById('totalPrice').value),
                    floorArea: parseFloat(document.getElementById('floorArea').value),
                    description: document.getElementById('description').value.trim() || null
                };

                console.log('準備儲存的資料：', formData);

                // 這裡之後會呼叫 API
                // if (currentEditingId) {
                //     // 更新
                //     updateHouseViaAPI(formData);
                // } else {
                //     // 新增
                //     createHouseViaAPI(formData);
                // }

                // 暫時顯示成功訊息
                alert(currentEditingId ? '房屋資料更新成功！' : '房屋新增成功！');

                // 關閉 Modal
                bootstrap.Modal.getInstance(document.getElementById('houseModal')).hide();

                // 重新載入列表
                loadHouseList();
            }
        }

        // 刪除房屋
        function deleteHouse(houseId) {
            currentDeletingId = houseId;

            const house = findHouseById(houseId);
            const houseName = house ? house.houseName : '未知房屋';

            document.getElementById('deleteHouseName').textContent = houseName;

            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        }

        // 確認刪除
        function confirmDelete() {
            if (currentDeletingId) {
                console.log('刪除房屋 ID：', currentDeletingId);

                // 這裡之後會呼叫 API
                // deleteHouseViaAPI(currentDeletingId);

                // 暫時顯示成功訊息
                alert('房屋刪除成功！');

                // 關閉 Modal
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();

                // 重新載入列表
                loadHouseList();

                currentDeletingId = null;
            }
        }

        // 表單驗證
        function validateForm() {
            const form = document.getElementById('houseForm');
            let isValid = true;

            // 清除之前的驗證樣式
            clearValidationStyles();

            // 驗證必填欄位
            const requiredFields = ['houseName', 'address', 'totalPrice', 'floorArea'];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.add('is-valid');
                }
            });

            // 驗證數值欄位
            const totalPrice = document.getElementById('totalPrice');
            const floorArea = document.getElementById('floorArea');

            if (totalPrice.value && parseFloat(totalPrice.value) <= 0) {
                totalPrice.classList.remove('is-valid');
                totalPrice.classList.add('is-invalid');
                isValid = false;
            }

            if (floorArea.value && parseFloat(floorArea.value) <= 0) {
                floorArea.classList.remove('is-valid');
                floorArea.classList.add('is-invalid');
                isValid = false;
            }

            return isValid;
        }

        // 清除驗證樣式
        function clearValidationStyles() {
            const form = document.getElementById('houseForm');
            const inputs = form.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.classList.remove('is-valid', 'is-invalid');
            });
        }

        // 搜尋功能
        document.getElementById('searchBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            console.log('搜尋條件：', searchTerm);

            if (!searchTerm) {
                // 如果搜尋條件為空，顯示全部資料
                renderHouseTable(housesData);
                return;
            }

            // 本地搜尋過濾
            const filteredHouses = housesData.filter(house =>
                house.houseName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                house.address.toLowerCase().includes(searchTerm.toLowerCase())
            );

            renderHouseTable(filteredHouses);
        });

        // 按 Enter 鍵搜尋
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });
    </script>
}

<style>
    .table th {
        white-space: nowrap;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .text-success {
        font-weight: 600;
    }

    .form-control-plaintext {
        padding-left: 0;
        border-bottom: 1px solid #dee2e6;
        background-color: transparent;
    }

    .modal-lg {
        max-width: 800px;
    }

    .invalid-feedback {
        display: block;
    }

    .pagination {
        margin-top: 1rem;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    #loadingIndicator {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    #noDataMessage {
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
</style>